\section{Получение результата в общем случае}

Теперь мы хотим избавиться от условия монотонности веса по $x$.
Мы будем это делать в несколько этапов.

Для начала отметим, что все свойства функции $a$ интересуют нас
лишь в окрестности графиков функций $u$, $u^*$.

Мы докажем теорему для кусочно линейных по $x$ весов при условии,
что абсциссы узлов разбиения не зависят от $u$.
После этого мы перейдем к общему случаю.

Введем следующие ограничения на весовую функцию:

\bigskip

\smallskip
\noindent
(H1) $a(x, v)$ удовлетворяет неравенству (\ref{almostConcave}),
непрерывна, а также $I(a, u) < \infty$.
\smallskip

\bigskip
\noindent
$(H2)$ На множестве $v \in [\min u(x), \max u(x)]$,
для которых $a(\cdot, v) \not\equiv 0$,
количество нулей функций $a(\cdot, v)$ ограничено константой,
не зависящей от $v$.

\bigskip
\noindent
$(H3)$ Если $a(x_0, u(x_0)) = 0$ для некоторого $x_0$, то $a(\cdot, u(x_0)) \equiv 0$.
Кроме того, выполнено $\lim_{k \to \infty} D_k(a, U(a)) = 0$, где
$$U(a) := \{ v \in [\min u(x), \max u(x)]: a(\cdot, v) \not \equiv 0 \},$$
\begin{equation}
\label{bigD}
D_k(a, U) := \sup\limits_{v \in U}
\frac{\max\limits_{ \abs{x_1 - x_2} \le \frac{2}{k} } \abs{a(x_1, v) - a(x_2, v)} }
{\min\limits_{|u(x) - v| \le \frac{2}{k}} a(x, v)}.
\end{equation}

\bigskip
\noindent
$(H4)$ Найдется такое четное $k$, что $a(\cdot, v)$ линейны для каждого $v$ на участках
$[-1 + \frac{2i}{k}, -1 + \frac{2(i + 1)}{k}]$.

\bigskip
\noindent
$(H5)$ Множество $v \in \Real$, для которых $a(\cdot, v)$ имеет участки постоянства,
отличается от множества $v \in \Real$ таких, что $a(\cdot, v) \equiv 0$,
лишь на множество меры $0$.

\bigskip
\noindent
$(H6)$ $[-1, 1]$ можно разбить на конечное число промежутков,
в $u$-окрестности графика $u(x)$ на каждом из которых вес $a$ имеет одну монотонность по $x$.

\bigskip
\noindent
$(H7)$ Пусть $x_1 < x_2 < x_3$,
и на $[x_1, x_2]$ вес $a(\cdot, v)$ в $u$-окрестности графика функции $u$ убывает,
а на $[x_2, x_3]$ возрастает.
Тогда в некоторой окрестности точки $u(x_2)$ имеем $a(\cdot, v) \equiv 0$.

\bigskip

Вес, удовлетворяющий условию $(H1)$, мы будем называть допустимым для заданной функции $u(x)$.

Мы докажем неравенство (\ref{toprove}) при условиях $(H1)-(H7)$,
а затем будем избавляться от лишних условий.

Для доказательства нам потребуются следующие факты.

\begin{prop}
\label{levelDerivative}
\cite[стр. 137]{LL}
Для любой $u \in \W(-1, 1)$ и произвольного множества $A \subset \Real$ нулевой меры выполнено
$u'(x) = 0$ для почти всех $x \in u^{-1}(A)$.
\end{prop}

\begin{lm}
\label{zeroApprox}
Пусть $u \in \W(-1, 1)$.
Предположим, что вес $a$ является допустимым для $u$, и имеется замкнутое множество
$W \subset \Real$ такое, что множество $v \in W$, для которых $a(\cdot, v) \not\equiv 0$,
имеет меру ноль.
Тогда найдется возрастающая последовательность допустимых для $u$ весов $b_k$ такая, что

1) $b_k(\cdot, v) \rightrightarrows a(\cdot, v)$ для почти всех $v$

2) для любого $v$ в некоторой окрестности $W$ (зависящей от $k$) $b_k(\cdot, v) \equiv 0$

3) $I(b_k, u) \to I(a, u)$.
\end{lm}

\begin{proof}
Возьмем $\rho(d) := \min(1, \max(0, d))$,
$$b_k(x, v) := a(x, v) \cdot \rho(k \dist(v, W) - 1) \le a(x, v).$$
Этот вес равен нулю в $\left(\frac{1}{k}\right)$-окрестности $W$.
Кроме того, $b_k \equiv a$ вне $\left(\frac{2}{k}\right)$-окрестности $W$ и
$b_k(x, v)$ возрастают при увеличении $k$.
Тем самым, $b_k(\cdot, v) \rightrightarrows a(\cdot, v)$ для почти всех $v$.
По теореме о монотонной сходимости интеграла
$I(u^{-1}(\Real \setminus W), b_k, u) \nearrow I(u^{-1}(\Real \setminus W), a, u)$.

Разобьем множество $W$ на два: $W_1 := \{v \in W: a(\cdot, v) \equiv 0\}$ и $W_2 = W \setminus W_1$.
$$I(u^{-1}(W_1), b_k, u) = I(u^{-1}(W_1), a, u).$$
$$I(u^{-1}(W_2), b_k, u) = \int\limits_{x \in u^{-1}(W_2)} F(u(x), b_k(x, u(x)) u'(x)) dx.$$
При этом, по предложению \ref{levelDerivative}, почти всюду на $u^{-1}(W_2)$
выполнено $u'(x) = 0$.
То есть
$$I(u^{-1}(W_2), b_k, u) = \int\limits_{x \in u^{-1}(W_2)} F(u(x), 0) dx = 0.$$
Аналогично, $I(u^{-1}(W_2), a, u) = 0$, откуда $I(b_k, u) \to I(a, u)$.
\end{proof}

Перейдем к доказательству неравенства (\ref{toprove}).

\bigskip
{\bf Шаг 1.} Пусть $u \in \W(-1, 1)$, и вес удовлетворяет условиям $(H1)-(H7)$.
Тогда выполняется неравенство (\ref{toprove}).

Разобьем отрезок $[-1, 1]$ на отрезки $\Delta_k$, состоящие из двух частей.
В левой части каждого отрезка вес $a$ будет возрастать по $x$ в окрестности
графика $u(x)$. В правой же будет убывать.
На каждом таком отрезке можно повторить схему из предыдущего параграфа,
приближая функцию $u$ липшицевыми функциями $u_n$.
Это дает $I(\Delta_k, a, u_n) \to I(\Delta_k, a, u)$.

Однако при такой аппроксимации функции $u_n$ имеют разрывы на границах отрезков $\Delta_k$
(обозначим их $\hat{x}_k$).

Заметим теперь, что согласно условию $(H7)$ можно выбрать точки $\hat{x}_k$ так,
что $a \equiv 0$ в $(x, u)$-окрестности точек $(\hat{x}_k, u(\hat{x}_k))$.

Изменим теперь функции $u_n$ в окрестности точек $\hat{x}_k$ на линейные,
сделав $u_n$ непрерывными на $[-1, 1]$.
В силу вышесказанного, это не изменит интегралов $I(\Delta_k, a, u_n)$,
и мы получаем $I(a, u_n) \to I(a, u)$.

По лемме \ref{uplift} получаем (\ref{toprove}).

\bigskip

{\bf Шаг 2.} Пусть вес удовлетворяет условиям $(H1)-(H6)$.
Тогда выполняется неравенство (\ref{toprove}).

Применим лемму \ref{zeroApprox}. В качестве множества $W$ возьмем множество
всех $v$, при которых происходит переход графика $u(x)$ из прямоугольника,
в котором вес убывает по $x$, в прямоугольник, в котором вес возрастает.
Очевидно, получившиеся $b_k$ удовлетворяют $(H7)$.
Поэтому $I(b_k, u^*) \le I(b_k, u)$.
Переходя к пределу, получаем (\ref{toprove}).

\bigskip

{\bf Шаг 3.} Пусть вес удовлетворяет условиям $(H1)-(H5)$.
Тогда выполняется неравенство (\ref{toprove}).

Прямоугольник $[-1, 1] \times [\min u(x), \max u(x)]$ естественным образом
делится абсциссами излома веса $a$ и участками постоянства $a$ по $x$ на прямоугольники,
в которых вес $a$ имеет постоянную монотонность по $x$.
Однако количество таких прямоугольников может оказаться бесконечным.
Кроме того, если функция пересекает горизонтальную границу прямоугольника,
монотонность в $u$-окрестности точки пересечения может меняться.

Возьмем множество $v$, для которых вес имеет участки постоянства по $x$,
в качестве $W$.
В соответствии с $(H5)$ множество $W$ имеет меру $0$.
Применим к нему лемму \ref{zeroApprox}.
Предположим теперь, что какая-то из $b_k$, полученных в результате
применения леммы, не удовлетворяет $(H6)$.
Это значит, что найдется сколь угодно малый интервал $(v_1, v_2)$,
на котором нельзя покрыть график $u(x)$ прямоугольниками с одинаковой
монотонностью веса по $x$.
Но этот интервал также должен пересекаться с $W$, а тогда, при
достаточно малой величине $v_2 - v_1$, $a(x, v) = 0$ при $v \in [v_1, v_2]$,
что противоречит предположению.

\bigskip
Избавимся от $(H4)$ и $(H5)$.

Предположим, функция $a$ удовлетворяет $(H1)$--$(H3)$, в том числе $I(a, u) < \infty$.
Сначала приблизим ее снизу кусочно линейными.
Поскольку приближающие кусочно линейные функции
по построению будут строго меньше $a$ (кроме нулей), можно пользоваться тем, что
$I(u^*) < \infty$ для таких весов.
И, тем самым, для второго перехода можно пользоваться теоремой о мажорированной сходимости.

Зафиксируем некоторое $k$.
По точкам $a(-1 + \frac{2i}{k}, v)$ для каждого $v$ построим кусочно линейную функцию.
Получившаяся функция $a_k(x, v)$ непрерывна и,
по лемме \ref{piecewiseLinearConcave}, удовлетворяет неравенству
(\ref{almostConcave}).

Возьмем $c_k := (1 - D_k(a_k, U(a_k))) a_k$.
$D_k(a_k, U(a_k))$ положителен и стремится к $0$, поэтому $c_k \to a$.
Покажем, что $c_k \le a$.
Возьмем некоторый
$x \in [-1 + \frac{2i}{k}, -1 + \frac{2(i + 1)}{k}] =: [x_1, x_2]$.
Тогда $c_k(x, u(x)) \le \max( c_k(x_1, u(x)), c_k(x_2, u(x)) )$, поскольку
$c_k$ кусочно линейны по $x$. Далее,
$c_k(x_1, u(x)) = (1 - D_k(a_k, U(a_k))) a(x_1, u(x)) \le
a(x_1, u(x)) - \frac{a(x_1, u(x)) - a(x, u(x))}{a(x_1, u(x))} a(x_1, u(x)) = a(x, u(x))$.
Аналогично $c_k(x_2, u) \le a(x, u(x))$.
Тем самым, $c_k(x, u(x)) \le a(x, u(x))$ для любого $x$, и $c_k$ являются допустимыми.

$F(u(x), c_k(x, u(x)) u'(x)) \to F(u(x), a(x, u(x)) u'(x))$ для любой функции $u$.
Кроме того, $F(u(x), a(x, u(x)) u'(x))$ является суммируемой мажорантой.
По теореме Лебега о мажорируемой сходимости, получаем $I(c_k, u) \to I(a, u)$
и $I(c_k, u^*) \to I(a, u^*)$.
Функции $c_k$ удовлетворяют $(H1)$--$(H4)$.

Обозначим некоторую $c_k=:c$ и будем приближать ее весами, удовлетворяющими $(H1)$--$(H5)$.
Рассмотрим функцию $\Lambda(x) = \frac{k}{2} (1 - \abs{x})$,
она удовлетворяет условию (\ref{almostConcave}).
Найдется такая функция $t(v) \ge 0$ такая, что $t(v) = 0$ равносильно $c(\cdot, v) \equiv 0$, и
$c(x, v) + \Lambda(x) t(v)$ удовлетворяет условиям $(H1)$--$(H4)$.

А именно: возьмем в качестве $t(v):=D_k(a_k, U(a_k)) \max\{\tau \ge 0: \forall x \in [-1, 1] \tau \Lambda(x) \le a_k(x, u(x))\}$.
Ясно, что максимальное $\tau$ равно нулю только если $a_k(\cdot, v) \equiv 0$, иначе нарушается условие
$(H3)$.
$t$ непрерывна, потому что веса кусочно линейные.

Тогда для каждого $\alpha \le 1$ функция $a(x, v) + \alpha \Lambda(x) t(v)$
тоже удовлетворяет условиям $(H1)$--$(H4)$.

Покажем, что в окрестности $0$ найдется достаточное количество $\alpha$ таких,
что $a(x, v) + \alpha \Lambda(x) t(v)$ не имеет горизонтальных участков, кроме
сплошных нулей и множества меры $0$.
Обозначим множество $\alpha$, неподходящих на участке $[x_i, x_{i + 1}]$
$$A_i := \{ \alpha \in [0, 1]: \abs{ \{ v \in [\min u, \max u]: a(x_{i + 1}, v) - a(x_i, v)) + \alpha t(v) = 0 \} } > 0 \}.$$
Рассмотрим функцию $h(v) = \frac{a(x_{i + 1}, v) - a(x_i, v)}{t(v)}$ при $t(v) \neq 0$ и $h(v) = 0$ при $t(v) = 0$.
Тогда $\#A_i = \#\{ \alpha \in [0, 1]: \abs{ \{ v \in [\min u, \max u]: h(v) + \alpha = 0 \} } > 0 \} (-1).$
(Во втором множестве может появиться лишний $0$.)
Значит, $\#A_i \le \aleph_0$, а также $\#\cup A_i \le \aleph_0$.
Тем самым, найдется последовательность допустимых функций $a(x, v) + \alpha_j \Lambda(x) t(v)$,
удовлетворяющих $(H1)$--$(H5)$ и сходящихся к $a(x, v)$.

\bigskip
Избавимся от $(H3)$.

Возьмем вес $a$, удовлетворяющий $(H1)$--$(H2)$.
Из $(H2)$ следует, что найдется множество $T \subset [-1, 1]$,
состоящее из конечного числа элементов, такое, что
если $x \not \in T$ и $a(x, v) = 0$ для некоторого $v$, то $a(\cdot, v) \equiv 0$.
Вновь воспользуемся леммой (\ref{zeroApprox}) с множеством
$W = u(T) \cup u^*(T)$.

Полученные веса удовлетворяют $(H1)$--$(H2)$, поскольку отличаются от $a$ лишь
домножением на непрерывный множитель меньший единицы и зависящий только от $v$.
Кроме того, $\min\limits_{x \in C_k(v)} a(x, v)$ не равен нулю на множестве
$U(b_k)$ начиная с некоторого $k$, значит $D_k(b_k, U(b_k)) = D_k(a, U(b_k)) \to 0$.

\bigskip
Избавимся от $(H2)$.

Предположим, вес $a$ является допустимым.
Будем строить приближение для него весами, удовлетворяющими $(H1)$--$(H2)$.
Воспользуемся леммой \ref{zeroApprox}.
В качестве множества $W$ возьмем $\{ v \in \Real: a(\cdot, v) \equiv 0 \}$.
Введем обозначение $Z_a(v) := \{ x \in [-1, 1]: a(x, v) = 0 \}$.
Заметим, что множества $Z_{b_k}(v)$ отличаются от $Z_a(v)$ лишь сменой для
некоторых $v$ на весь отрезок $[-1, 1]$.
Нам остается доказать, что полученные $b_k$ удовлетворяют $(H2)$,
то есть найдется число $p$ такое, что для каждого $v$ множество
$Z_{b_k}(v)$ либо совпадает с отрезком $[-1, 1]$, либо $\#Z_{b_k}(v) \le p$.

Предположим, это не так, и найдется последовательность $v_l$, для которой
$l < \#Z_{b_k}(v_l) < \infty$.
Тогда, после перехода к подпоследовательности, она будет стремиться к некоторому
$v_0$. Более того, $Z_{b_k}(v_l) = Z_a(v_l)$, поскольку $Z_{b_k}(v_l) \neq [-1, 1]$.
Покажем, что $Z_a(v_0) = [-1, 1]$. Из леммы \ref{periodicity} следует, что
множества $Z_a(v_l)$ периодические с периодом не более $\frac{2}{l - 1}$.
Возьмем некоторый $x \in [-1, 1]$. Для каждого $l$ найдется $x_l$ такой, что
$\abs{x - x_l} \le \frac{1}{l - 1}$ и $a(x_l, v_l) = 0$.
Но $a(x_l, v_l) \to a(x, v_0)$.
Тем самым, $a(x, v_0) = 0$ и $Z_a(v_0) = [-1, 1]$.
Но это означает, что для каждого $v$ такого,
что $\abs{v - v_0} \le \frac{1}{k}$, выполнено $b_k(\cdot, v) \equiv 0$,
что противоречит $\#Z_{b_k}(v_l) < \infty$.

Тем самым, неравенство (\ref{toprove}) доказано для всех допустимых весов.
\section{Получение результата в общем случае}

Теперь мы хотим избавиться от условия монотонности веса по $x$.
Мы будем это делать в несколько этапов.

Для начала отметим, что все свойства функции $a$ интересуют нас
лишь в окрестности графиков функций $u$, $u^*$.

Введем следующие ограничения на весовую функцию:

\bigskip

\smallskip
\noindent
$(H1)$ $a(x, v)$ четна по $x$ и удовлетворяет неравенству (\ref{almostConcave}),
а также $I(a, u) < \infty$.
\smallskip

\bigskip
\noindent
$(H2)$ На множестве $v \in [\min u(x), \max u(x)]$,
для которых $a(\cdot, v) \not\equiv 0$,
количество нулей функций $a(\cdot, v)$ ограничено константой,
не зависящей от $v$.

\bigskip
\noindent
$(H3)$ Если $a(x_0, u(x_0)) = 0$ для некоторого $x_0$, то $a(\cdot, u(x_0)) \equiv 0$.
Кроме того, выполнено $\lim_{k \to \infty} D_k(a, U(a)) = 0$, где
$$U(a) := \{ v \in [\min u(x), \max u(x)]: a(\cdot, v) \not \equiv 0 \},$$
\begin{equation}
\label{bigD}
D_k(a, U) := \sup\limits_{v \in U}
\frac{\max\limits_{ \abs{x_1 - x_2} \le \frac{2}{k} } \abs{a(x_1, v) - a(x_2, v)} }
{\min\limits_{\dist(x, u^{-1}(v)) \le \frac{2}{k}} a(x, v)}.
\end{equation}

\bigskip
\noindent
$(H4)$ Найдется такое четное $k$, что $a(\cdot, v)$ линейны для каждого $v$ на участках
$[-1 + \frac{2i}{k}, -1 + \frac{2(i + 1)}{k}]$.

\bigskip
\noindent
$(H5)$ Множество $v \in \Real$, для которых $a(\cdot, v)$ имеет участки постоянства,
отличается от множества $v \in \Real$ таких, что $a(\cdot, v) \equiv 0$,
лишь на множество меры $0$.

\bigskip
\noindent
$(H6)$ Отрезок $[-1, 1]$ можно разбить на конечное число промежутков,
на каждом из которых в $v$-окрестности графика $u(x)$ вес $a$ не меняет монотонности по $x$.

\bigskip
\noindent
$(H7)$ Пусть $x_1 < x_2 < x_3$,
и на $[x_1, x_2]$ вес $a(\cdot, v)$ в $v$-окрестности графика функции $u$ убывает,
а на $[x_2, x_3]$ возрастает.
Тогда в некоторой окрестности точки $u(x_2)$ имеем $a(\cdot, v) \equiv 0$.

\bigskip

Вес, удовлетворяющий условию $(H1)$, мы будем называть допустимым для заданной функции $u(x)$.

Теперь мы можем сформулировать основное утверждение нашей работы.
\begin{thm}
\label{mainThm}
Пусть $F \in \mathfrak{F}$, функция $u \in \W(-1, 1)$ неотрицательна,
и весовая функция $a: [-1, 1] \times \Real_+ \to \Real_+$ непрерывна
и допустима для $u$.
Тогда справедливо неравенство (\ref{toprove}).
\end{thm}

Мы докажем неравенство (\ref{toprove}) при условиях $(H1)-(H7)$,
а затем будем избавляться от лишних условий.

Для доказательства нам потребуются следующие факты.

\begin{prop}
\label{levelDerivative}
\cite[теорема 6.19]{LL}
Для любой $u \in \W(-1, 1)$ и произвольного множества $A \subset \Real$ нулевой меры выполнено
$u'(x) = 0$ для почти всех $x \in u^{-1}(A)$.
\end{prop}

\begin{lm}
\label{zeroApprox}
Пусть $u \in \W(-1, 1)$ и вес $a$ является допустимым для $u$.
Пусть замкнутое множество
$W \subset \Real$ таково, что множество $v \in W$, для которых $a(\cdot, v) \not\equiv 0$,
имеет меру ноль.
Тогда найдется возрастающая последовательность допустимых для $u$ весов $b_k$ такая, что

1) $b_k(\cdot, v) \rightrightarrows a(\cdot, v)$ для почти всех $v$;

2) $b_k(\cdot, v) \equiv 0$ для любого $v$ в некоторой (зависящей от $k$) окрестности $W$;

3) $I(b_k, u) \to I(a, u)$.
\end{lm}

\begin{proof}
Возьмем $\rho(d) := \min(1, \max(0, d))$,
$$b_k(x, v) := a(x, v) \cdot \rho(k \dist(v, W) - 1) \le a(x, v).$$
Этот вес равен нулю в $\left(\frac{1}{k}\right)$-окрестности $W$.
Кроме того, $b_k \equiv a$ вне $\left(\frac{2}{k}\right)$-окрестности $W$ и
$b_k(x, v)$ возрастают при увеличении $k$.
Тем самым, $b_k(\cdot, v) \rightrightarrows a(\cdot, v)$ для почти всех $v$.
По теореме о монотонной сходимости интеграла
$I(u^{-1}(\Real \setminus W), b_k, u) \nearrow I(u^{-1}(\Real \setminus W), a, u)$.

Разобьем множество $W$ на два: $W_1 := \{v \in W: a(\cdot, v) \equiv 0\}$ и $W_2 = W \setminus W_1$.
$$I(u^{-1}(W_1), b_k, u) = I(u^{-1}(W_1), a, u).$$
$$I(u^{-1}(W_2), b_k, u) = \int\limits_{x \in u^{-1}(W_2)} F(u(x), b_k(x, u(x)) u'(x)) dx.$$
При этом, по предложению \ref{levelDerivative}, почти всюду на $u^{-1}(W_2)$
выполнено $u'(x) = 0$.
То есть
$$I(u^{-1}(W_2), b_k, u) = \int\limits_{x \in u^{-1}(W_2)} F(u(x), 0) dx = 0.$$
Аналогично, $I(u^{-1}(W_2), a, u) = 0$, откуда $I(b_k, u) \to I(a, u)$.
\end{proof}

Перейдем к доказательству теоремы.

\bigskip
{\bf Шаг 1.} Пусть $u \in \W(-1, 1)$, и вес $a$ удовлетворяет условиям $(H1)-(H7)$.
Тогда выполняется неравенство (\ref{toprove}).

Разобьем отрезок $[-1, 1]$ на отрезки $\Delta_k$, состоящие из двух частей.
В левой части каждого отрезка вес $a$ будет возрастать по $x$ в окрестности
графика $u(x)$. В правой же будет убывать.
На каждом таком отрезке можно повторить схему из предыдущего параграфа,
приближая функцию $u$ липшицевыми функциями $u_n$.
Это дает $I(\Delta_k, a, u_n) \to I(\Delta_k, a, u)$.

Однако при такой аппроксимации функции $u_n$ имеют разрывы на границах отрезков $\Delta_k$
(обозначим их $\hat{x}_k$).

Заметим теперь, что согласно условию $(H7)$ можно выбрать точки $\hat{x}_k$ так,
что $a \equiv 0$ в $(x, v)$-окрестности точек $(\hat{x}_k, u(\hat{x}_k))$.

Изменим теперь функции $u_n$ в окрестности точек $\hat{x}_k$ на линейные,
сделав $u_n$ непрерывными на $[-1, 1]$.
В силу вышесказанного, интегралов $I(\Delta_k, a, u_n)$ это не изменит,
и мы получаем $I(a, u_n) \to I(a, u)$.

По лемме \ref{uplift} получаем (\ref{toprove}).

\bigskip

{\bf Шаг 2.} Пусть вес $a$ удовлетворяет условиям $(H1)-(H6)$.
Тогда выполняется неравенство (\ref{toprove}).

Применим лемму \ref{zeroApprox}. В качестве множества $W$ возьмем множество
всех $v$, при которых происходит переход графика $u(x)$ из прямоугольника,
в котором вес убывает по $x$, в прямоугольник, в котором вес возрастает.
Очевидно, получившиеся функции $b_k$ удовлетворяют $(H1)-(H7)$.
Поэтому $I(b_k, u^*) \le I(b_k, u)$.
Переходя к пределу, получаем (\ref{toprove}).

\bigskip

{\bf Шаг 3.} Пусть вес $a$ удовлетворяет условиям $(H1)-(H5)$.
Тогда выполняется неравенство (\ref{toprove}).

Прямоугольник $[-1, 1] \times [\min u(x), \max u(x)]$ естественным образом
делится абсциссами излома веса $a$ и участками постоянства $a$ по $x$ на прямоугольники,
в которых вес $a$ имеет постоянную монотонность по $x$.
Однако количество таких прямоугольников может оказаться бесконечным.
Кроме того, если функция пересекает горизонтальную границу прямоугольника,
монотонность в $v$-окрестности точки пересечения может меняться.

Возьмем множество $v$, для которых вес имеет участки постоянства по $x$,
в качестве $W$.
В соответствии с $(H5)$ множество $v \in W$, для которых $a(\cdot, v) \not\equiv 0$,
имеет меру $0$.

Применив лемму \ref{zeroApprox}, построим последовательность весов $b_k$.
У каждого из них количество участков монотонности конечно,
поскольку между соседними по $v$ участками строгой монотонности
присутствует полоса нулевых значений веса шириной по крайней мере $\frac{2}{k}$.

Отметим теперь на каждом участке монотонности точку на графике функции $u$.
Множество этих точек не может иметь точек скопления,
поскольку между точками, в которых разная монотонность,
расстояние по $v$ по крайней мере $\frac{2}{k}$.

Тем самым, $b_k$ удовлетворяют $(H1)-(H6)$. Поэтому $I(b_k, u^*) \le I(b_k, u)$.
Переходя к пределу, получаем (\ref{toprove}).

\bigskip
{\bf Шаг 4.} Пусть вес $a$ удовлетворяет условиям $(H1)-(H3)$.
Тогда выполняется неравенство (\ref{toprove}).

Предположим, функция $a$ удовлетворяет $(H1)-(H3)$, в том числе $I(a, u) < \infty$.

Зафиксируем произвольное четное $k$.
По точкам $a(-1 + \frac{2i}{k}, v)$ для каждого $v$ построим кусочно линейную по $x$ интерполяцию.
Получившаяся функция $a_k(x, v)$ непрерывна, четна и,
по лемме \ref{piecewiseLinearConcave}, удовлетворяет неравенству
(\ref{almostConcave}).
Кроме того, $a_k \to a$ при $k \to \infty$,
причем сходимость равномерная на компактах.
Однако неравенство $a_k(x, u(x)) \le a(x, u(x))$ не обязано выполняться,
и потому веса $a_k$ могут не быть допустимыми для $u$.

Возьмем $c_k := (1 - D_k(a_k, U(a_k))) a_k$, где $D_k$ определены в (\ref{bigD}).
Числа $D_k(a_k, U(a_k))$ положительны и стремятся к нулю, поэтому $c_k \to a$ при $k \to \infty$.
Покажем, что $c_k(x, u(x)) \le a(x, u(x))$.
Возьмем некоторое
$x \in [-1 + \frac{2i}{k}, -1 + \frac{2(i + 1)}{k}] =: [x_i, x_{i + 1}]$.
Тогда $c_k(x, u(x)) \le \max( c_k(x_i, u(x)), c_k(x_{i + 1}, u(x)) )$, поскольку
$c_k$ кусочно линейны по $x$. Далее,
\begin{multline*}
c_k(x_i, u(x)) = (1 - D_k(a_k, U(a_k))) \cdot a(x_i, u(x)) \\
\le a(x_i, u(x)) - \frac{a(x_i, u(x)) - a(x, u(x))}{a(x_i, u(x))} \cdot a(x_i, u(x)) = a(x, u(x)).
\end{multline*}
Аналогично $c_k(x_{i + 1}, u(x)) \le a(x, u(x))$.
Тем самым, $c_k(x, u(x)) \le a(x, u(x))$ для любого $x$, и $c_k$ являются допустимыми для $u$.

Функции $c_k$ удовлетворяют $(H1)-(H4)$.

При заданном $k \in \Nat$, будем приближать функцию $c_k =: c$ весами, удовлетворяющими $(H1)-(H5)$.
Рассмотрим вспомогательную функцию $\Lambda(x) = 1 - \abs{x}$,
удовлетворяющую условию (\ref{almostConcave}).

Возьмем
$$t(v):=D_k(c, U(c)) \cdot \max\{\tau \ge 0: \forall x \in u^{-1}(v) \quad \tau \Lambda(x) \le c(x, u(x))\}.$$
Функция $t$ зависит от $k$, но мы будем опускать это в записи.

Ясно, что максимальное $\tau$ равно нулю только если $c(\cdot, v) \equiv 0$, иначе нарушается условие
$(H3)$.
Функция $t$ может не быть непрерывной. Однако, несложно видеть, что она полунепрерывна снизу.
Возьмем теперь
$$\tilde{t}(v) := \inf_{w \in u([-1, 1])} \{t(w) + |v - w|\}.$$
Очевидно, что $\tilde{t} \le t$, и множества нулей функций $t$ и $\tilde{t}$ совпадают.

Покажем, что $\tilde{t}$ непрерывна (и даже липшицева).
Зафиксируем некоторое $v_1$.
Тогда найдутся сколь угодно малое $\eps > 0$ и $w_1 \in u([-1, 1])$,
удовлетворяющие $\tilde{t}(v_1) = t(w_1) + |v_1 - w_1| - \eps$.
Для любого $v_2$ имеем $\tilde{t}(v_2) \le t(w_1) + |v_2 - w_1|$.
И, тем самым, $\tilde{t}(v_2) - \tilde{t}(v_1) \le |v_1 - v_2| + \eps$.
В силу произвольности $v_1$, $v_2$ и $\eps$, получаем, что $\tilde{t}$ непрерывна.

При $\alpha \in [0, 1]$ функция $d_\alpha(x, v) := c(x, v) + \alpha \Lambda(x) \tilde{t}(v)$
четна по $x$, удовлетворяет неравенству (\ref{almostConcave}) согласно лемме \ref{maxSumConcave}
и не превосходит $a(x, v)$ по построению функции $\tilde{t}$.
Таким образом, $d_\alpha$ --- допустимый вес.
Далее, очевидно, что $d_\alpha$ удовлетворяет условиям $(H1)-(H4)$.

Покажем, что найдется последовательность $\alpha_j \searrow 0$,
что $d_{\alpha_j}$ не имеет горизонтальных участков, кроме
сплошных нулей и множества меры $0$.
Обозначим множество $\alpha$, ``плохих'' на участке $[x_i, x_{i + 1}]$:
\begin{multline*}
A_i := \big\{ \alpha \in [0, 1]: \\
meas\{ v \in [\min u, \max u]: \frac{c(x_{i + 1}, v) - c(x_i, v))}{\frac{2}{k}} + \alpha \chi_i \tilde{t}(v) = 0 \} > 0 \big\},
\end{multline*}
где $\chi_i = 1$, если $[x_i, x_{i + 1}] \subset [0, 1]$, и $\chi_i = -1$, если $[x_i, x_{i + 1}] \subset [-1, 0]$.

Рассмотрим функцию
$$
\begin{aligned}
h(v) = &\frac{c(x_{i + 1}, v) - c(x_i, v)}{\tilde{t}(v)} &\text{ при } \tilde{t}(v) \neq 0&\\
h(v) = &0 &\text{ при } \tilde{t}(v) = 0&.
\end{aligned}
$$
Тогда $\card(A_i) = \card(\{ \alpha \in [0, 1]: meas \{ v \in [\min u, \max u]: h(v) \pm \frac{2}{k}\ \alpha = 0 \} > 0 \}).$
Значит, $\card(A_i) \le \aleph_0$, а также $\card(\cup_i A_i) \le \aleph_0$.
Тем самым, найдется последовательность весов $d_{\alpha_j} \searrow c$, удовлетворяющих $(H1)-(H5)$.
Поэтому $I(d_{\alpha_j}, u^*) \le I(d_{\alpha_j}, u)$.
Переходя к пределу, получим $I(c, u^*) \le I(c, u)$.

Далее, при $x \in [-1, 1]$ и $k \to \infty$ имеем
$$F(u(x), c_k(x, u(x)) |u'(x)|) \to F(u(x), a(x, u(x)) |u'(x)|).$$
Кроме того, $F(u(x), a(x, u(x)) |u'(x)|)$ является суммируемой мажорантой.
По теореме Лебега о мажорируемой сходимости, получаем $I(c_k, u) \to I(a, u)$.
Поскольку $I(c_k, u^*) \le I(c_k, u)$, лемма \ref{uplift} дает (\ref{toprove}).

\bigskip
{\bf Шаг 5.} Пусть вес $a$ удовлетворяет лишь условию $(H1)$.
Тогда выполняется неравенство (\ref{toprove}).

Будем строить приближение для $a$ весами, удовлетворяющими $(H1)-(H2)$.
Воспользуемся леммой \ref{zeroApprox}.
В качестве множества $W$ возьмем $\{ v \in \Real: a(\cdot, v) \equiv 0 \}$.
Введем обозначение $$Z_a(v) := \{ x \in [-1, 1]: a(x, v) = 0 \}.$$
Заметим, что множества $Z_{b_k}(v)$ совпадают либо с $Z_a(v)$, либо с $[-1, 1]$.

Покажем, что $b_k$ удовлетворяет $(H2)$.
Действительно, в противном случае найдется последовательность $v_l$, для которой
$l < \card(Z_{b_k})(v_l) < \infty$.
После перехода к подпоследовательности имеем $v_l \to v_0$.
Покажем, что $Z_a(v_0) = [-1, 1]$. Из леммы \ref{periodicity} следует, что
множества $Z_{b_k}(v_l) = Z_a(v_l)$ периодические с периодом не более $\frac{2}{l - 1}$.
Возьмем некоторый $x \in [-1, 1]$. Для каждого $l$ найдется $x_l$ такой, что
$\abs{x - x_l} \le \frac{1}{l - 1}$ и $a(x_l, v_l) = 0$.
Но $a(x_l, v_l) \to a(x, v_0)$.
Тем самым, $a(x, v_0) = 0$ и $Z_a(v_0) = [-1, 1]$.
Но это означает, что для каждого $v$ такого,
что $\abs{v - v_0} \le \frac{1}{k}$, выполнено $b_k(\cdot, v) \equiv 0$,
что противоречит $\card(Z_{b_k})(v_l) < \infty$.


Зафиксируем теперь $k \in \Nat$, обозначим $b_k =: b$
и приблизим функцию $b$ весами, удовлетворяющими $(H1)-(H3)$.
Из $(H2)$ и леммы \ref{periodicity}, часть 2, следует, что найдется множество $T \subset [-1, 1]$,
состоящее из конечного числа элементов, такое, что
если $x \not \in T$ и $a(x, v) = 0$ для некоторого $v$, то $b(\cdot, v) \equiv 0$.
Вновь воспользуемся леммой \ref{zeroApprox} с множеством
$W = u(T) \cup u^*(T)$.

Полученные при помощи леммы веса $c_j$ удовлетворяют $(H1)-(H2)$, поскольку отличаются от $b$ лишь
домножением на непрерывный множитель, меньший единицы и зависящий только от $v$.
Очевидно, $\min\limits_{dist(x, u^{-1}(v)) \le \frac{2}{j}} c_j(x, v)$ не равен нулю при
$v \in U(c_j)$, начиная с некоторого $j$.
Более того, при $v \in U(c_j)$
$$
\frac{\max\limits_{ \abs{x_i - x_{i + 1}} \le \frac{2}{j} } \abs{c_j(x_i, v) - c_j(x_{i + 1}, v)} }
{\min\limits_{\dist(x, u^{-1}(v)) \le \frac{2}{j}} c_j(x, v)}
=\frac{\max\limits_{ \abs{x_i - x_{i + 1}} \le \frac{2}{j} } \abs{b(x_i, v) - b(x_{i + 1}, v)} }
{\min\limits_{\dist(x, u^{-1}(v)) \le \frac{2}{j}} b(x, v)}.
$$
При этом, знаменатель второй дроби при $v \in U(c_j)$ отделен от нуля.
Тем самым, $D_j(c_j, U(c_j))$ ограничена.

Поскольку $D_j$ не меняется при домножении первого аргумента на коэффициент, не зависящий от $x$,
и $U(c_j) \nearrow U(b)$, имеем при $j \to \infty$
$$D_j(c_j, U(c_j)) = D_j(b, U(c_j)) \le D_j(b, U(b)) \to 0.$$

Таким образом, веса $c_j$ удовлетворяют $(H1)-(H3)$.
Тем самым, $I(c_j, u^*) \le I(c_j, u)$.
Переходя к пределу, получим $I(b_k, u^*) \le I(b_k, u)$, а затем и неравенство (\ref{toprove}).

Тем самым, теорема \ref{mainThm} доказана.
\hfill$\square$

\medskip

Рассмотрим теперь случай, когда функция $u$ удовлетворяет дополнительному условию $u(-1) = 0$.
\begin{thm}
Пусть $F \in \mathfrak{F}$, функция $u \in \W(-1, 1)$ неотрицательна, $u(-1) = 0$,
весовая функция $a: [-1, 1] \times \Real_+ \to \Real_+$ непрерывна
и удовлетворяет неравенству (\ref{almostConcave}).
Тогда справедливо неравенство (\ref{toprove}).
\end{thm}

\begin{proof}
Мы следуем схеме доказательства теоремы \ref{mainThm},
но вместо $(H1)$ и $(H7)$ накладываем следующие условия на вес:

\bigskip
\noindent
$(H1')$ $a(x, v)$ удовлетворяет неравенству (\ref{almostConcave}), а также $I(a, u) < \infty$.

\bigskip
\noindent
$(H7')$ Выполнено условие $(H7)$, и $a(\cdot, v) \equiv 0$ в некоторой $v$-окрестности нуля.

\bigskip
{\bf Шаг 1.} Пусть $u \in \W(-1, 1)$, выполнено $u(-1) = 0$, и вес $a$ удовлетворяет условиям $(H1'), (H2)-(H6), (H7')$.
Тогда выполняется неравенство (\ref{toprove}).

Будем приближать функцию $u$ так же, как и в первом шаге доказательства теоремы \ref{mainThm},
с заменой $u$ в некоторой окрестности точки $x = -1$ на линейную так, чтобы $u_n(-1) = 0$.

\bigskip
{\bf Шаг 2.} Пусть вес $a$ удовлетворяет условиям $(H1'), (H2)-(H6)$.
Тогда выполняется неравенство (\ref{toprove}).

Добавим в множество $W$ из второго шага доказательства теоремы \ref{mainThm} точку $0$
и повторим рассуждение.

\medskip

Дальнейшие шаги проходят без изменений.
\end{proof}
